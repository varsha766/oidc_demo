<!DOCTYPE html>
<html>

<head>
    <title>Console</title>
</head>

<body>
    <script>
        let developerToken
        async function checkSession() {
            const response = await fetch('http://localhost:3010/check-session')
            developerToken = await response.json()
            if (!developerToken.authToken) {
                fetchAuthUrl(developerToken)

            } else {
                localStorage.setItem('authToken', developerToken.authToken)
            }
        }
        async function fetchAuthUrl() {
            const response = await fetch('http://localhost:3010/authorizationUrl')
            const data = await response.json()
            window.location.href = data.authorizationUrl;
        }
        async function init() {
            await checkSession();
        }
        init();
    </script>


    <h1>OIDC-PROVIDER Console</h1>
    <form id="postForm">
        <label for="userId">userId</label>
        <input type="text" id="userId" name="userId" required><br>

        <label for="appName">App Name:</label>
        <input type="appName" id="appName" name="appName" required><br>

        <label for="appLogoUrl">LogoUrl:</label>
        <input type="appLogoUrl" id="appLogoUrl" name="appLogoUrl" required><br>

        <label for="redirect_uris">Redirect URIs (comma-separated):</label>
        <input type="text" id="redirect_uris" name="redirect_uris"><br>
        <label for="grant_types">Grant types (comma-separated):</label>
        <input type="text" id="grant_types" name="grant_types" required><br>
        <label for="scope">Scope (comma-separated):</label>
        <input type="text" id="scope" name="scope" required><br>
        <input type="submit" value="Submit">
    </form>

    <script>
        document.getElementById("postForm").addEventListener("submit", function (event) {
            event.preventDefault();

            // Get form values
            var userId = document.getElementById("userId").value;
            var appName = document.getElementById("appName").value;
            var appLogoUrl = document.getElementById("appLogoUrl").value;
            var redirectUris = document.getElementById("redirect_uris").value;
            var grantTypes = document.getElementById("grant_types").value;
            var scopes = document.getElementById("scope").value;

            // Create data object
            var data = {
                userId: userId,
                appName: appName,
                appLogoUrl: appLogoUrl,
                redirect_uris: redirectUris.split(',').map(function (uri) {
                    return uri.trim();
                }),
                grant_types: grantTypes.split(',').map(function (uri) {
                    return uri.trim();
                }),
                scope: scopes
            };
            const token = localStorage.getItem('authToken')
            // Send POST request
            fetch("http://localhost:3009/api/client-register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "authorizationToken": token
                },
                body: JSON.stringify(data)
            })
                .then(function (response) {
                    if (response.ok) {
                        return response.json()
                    } else {
                        alert("Error sending POST request");
                    }
                })
                .then(function (data) {
                    var alertText = `clientId:${data.clientId}\n clientSecret:${data.clientSecret}\n ID: ${data.id}`
                    alert(alertText)
                })
                .catch(function (error) {
                    console.error("Error:", error);
                });
        });
    </script>
</body>

</html>